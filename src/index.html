<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />

    <style>
      .pc-tc {
        border-radius: 50%;
        width: 315px;
        height: 315px;
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        background-color: #ccc;
        background-image: none;
        margin: 20px;
      }

      .pc-tc-overlay {
        border-radius: 50%;
        width: 299px;
        height: 299px;
        margin: auto;
        background: #fff;
        text-align: center;
        padding-top: 32%;
        display: flex;
        flex-direction: column;
      }

      .pc-tc-time {
        top: 50%;
        font-size: 64px;
        font-weight: bolder;
      }

      .pc-tc-state {
        font-size: 24px;
        font-weight: bold;
      }

      .pc-tc-session {
        font-size: 18px;
        font-weight: normal;
      }

      .pc-tc.inactive {
        background-color: #6c757d;
      }

      .pc-tc-time.inactive {
        color: #6c757d;
      }

      .pc-tc.work {
        background-color: #007bff;
      }

      .pc-tc-time.work {
        color: #007bff;
      }

      .pc-tc.break {
        background-color: #ffc107;
      }

      .pc-tc-time.break {
        color: #ffc107;
      }

      /* .progress-10 {
            background-image: linear-gradient(45deg, #028cd5 50%, transparent 50%), linear-gradient(180deg, #028cd5 50%, #ddd 50%);
        } */
    </style>

    <title>Pomodoro Clock</title>
  </head>

  <body>
    <!-- Title -->
    <header class="jumbotron jumbotron-fluid bg-transparent text-center py-4">
      <div class="container">
        <h1 class="display-4">Pomodoro Clock</h1>
      </div>
    </header>

    <!-- Main body -->
    <main id="root" class="container justify-content-between h-100"></main>

    <audio id="audio-alarm" preload="auto" src="audio/default.wav" />

    <!-- Internal script -->
    <script type="module">
      import $ from 'jquery';
      import 'bootstrap';

      import {toSecs, toMillisecs} from './js/time.mjs';
      import {Timer, TimerState} from './js/timer.mjs';
      import {TimerClockComponent} from './js/components/timer-clock-component.mjs';
      import {TimerControlsComponent} from './js/components/timer-controls-component.mjs';

      import {PomodoroConfigModal} from './js/modals/pomodoro-config-modal.mjs';

      const PomodoroState = {
        Inactive: 'inactive',
        Work: 'work',
        Break: 'break',
      };

      const AlarmSounds = [
        {name: 'Default', url: 'audio/default.wav'},
        {name: 'Geese', url: 'audio/geese.mp3'},
        {name: 'Huge bell', url: 'audio/hugebell.wav'},
        {name: 'Police siren', url: 'audio/police.wav'},
        {name: 'Railroad crossing bell', url: 'audio/railroad.wav'},
        {name: 'Rooster', url: 'audio/rooster.wav'},
        {name: 'Warning siren', url: 'audio/warningsiren.wav'},
        {name: 'Whistling', url: 'audio/whistling.wav'},
      ];

      const DefaultOptions = {
        alarm: {
          volume: 0.4,
          sound: 0,
        },
        sessionDuration: {
          work: 25,
          break: 5,
        },
      };

      $().ready(() => {
        // Application state.
        let work_duration = 25 * 60;
        let break_duration = 5 * 60;
        let nsession = 0;
        let timer = createTimer();

        // Clock component
        const timerClockComponent = new TimerClockComponent();

        // Configuration modal
        const configModal = new PomodoroConfigModal(
          {alarmSounds: AlarmSounds},
          DefaultOptions
        );

        // Timer controls.
        const timerControlsCallbacks = {
          onStart: () => set_state(TimerState.Running),
          onStop: () => set_state(TimerState.Stopped),
          onPause: () => set_state(TimerState.Paused),
          onResume: () => set_state(TimerState.Running),
          onReset: () => reset(),
          onShowOptions: () => configModal.show(),
        };
        const timerControlsComponent = new TimerControlsComponent(
          timerControlsCallbacks
        );

        // Media resources.
        const $audioAlarm = $('#audio-alarm');

        // Initial state.
        $('#root').append(
          timerClockComponent.rootElement,
          timerControlsComponent.rootElement
        );
        $('#body').append(configModal.rootElement);

        set_state(TimerState.Stopped);
        reset_options();

        // 'Public' functions

        function get_session_duration() {
          return is_break() ? work_duration : break_duration;
        }

        function is_break() {
          return nsession % 2 === 0;
        }

        function reset() {
          const wasRunning = timer.isRunning;
          set_session(0);
          wasRunning && timer.run();
        }

        function set_session(to) {
          nsession = to;
          timer.stop();
          timer = createTimer();
          timerClockComponent.elapsedTime = 0;
          timerClockComponent.duration = toMillisecs(get_session_duration());
          timerClockComponent.session = nsession;
          timerClockComponent.sessionType = nsession % 2;
        }

        function set_state(new_state) {
          const old_state = timer ? timer.state : undefined;
          const state = new_state;
          if (typeof old_state !== 'undefined') {
            switch (old_state) {
              case TimerState.Paused:
                break;
              case TimerState.Stopped:
                timer = createTimer();
              case TimerState.Running:
                break;
            }
          }
          switch (new_state) {
            case TimerState.Running:
              timer.run();
              break;
            case TimerState.Paused:
              timer.pause();
              break;
            case TimerState.Stopped:
            default:
              timer.stop();
              timerClockComponent.elapsedTime = 0;
              timerClockComponent.duration = toMillisecs(
                get_session_duration()
              );
              break;
          }
          timerClockComponent.timerState = new_state;
          timerControlsComponent.timerState = new_state;
        }

        // 'Private' functions

        function createTimer() {
          return new Timer(
            toMillisecs(get_session_duration()),
            () => {
              set_session(nsession + 1);
              $audioAlarm[0].play();
              timer.run();
            },
            ({elapsedTime}) => {
              timerClockComponent.elapsedTime = elapsedTime;
            }
          );
        }

        function reset_options() {
          $rangeVolume.val(100);
          $txtDurationWork.val(25);
          $txtDurationBreak.val(5);
          $selSound.val('default');
        }

        function button_swap(button, text, from, to) {
          button.text(text);
          button.removeClass(from);
          button.addClass(to);
        }

        function step(max, value, min, step) {
          value += step;
          if (max != null) {
            value = Math.min(parseInt(max), value);
          }
          if (min != null) {
            value = Math.max(parseInt(min), value);
          }
          return value;
        }
      });
    </script>
  </body>
</html>
