<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />

    <style>
      .pc-tc {
        border-radius: 50%;
        width: 315px;
        height: 315px;
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        background-color: #ccc;
        background-image: none;
        margin: 20px;
      }

      .pc-tc-overlay {
        border-radius: 50%;
        width: 299px;
        height: 299px;
        margin: auto;
        background: #fff;
        text-align: center;
        padding-top: 32%;
        display: flex;
        flex-direction: column;
      }

      .pc-tc-time {
        top: 50%;
        font-size: 64px;
        font-weight: bolder;
      }

      .pc-tc-state {
        font-size: 24px;
        font-weight: bold;
      }

      .pc-tc-session {
        font-size: 18px;
        font-weight: normal;
      }

      .pc-tc.inactive {
        background-color: #6c757d;
      }

      .pc-tc-time.inactive {
        color: #6c757d;
      }

      .pc-tc.work {
        background-color: #007bff;
      }

      .pc-tc-time.work {
        color: #007bff;
      }

      .pc-tc.break {
        background-color: #ffc107;
      }

      .pc-tc-time.break {
        color: #ffc107;
      }

      /* .progress-10 {
            background-image: linear-gradient(45deg, #028cd5 50%, transparent 50%), linear-gradient(180deg, #028cd5 50%, #ddd 50%);
        } */
    </style>

    <title>Pomodoro Clock</title>
  </head>

  <body>
    <!-- Title -->
    <header class="jumbotron jumbotron-fluid bg-transparent text-center py-4">
      <div class="container">
        <h1 class="display-4">Pomodoro Clock</h1>
      </div>
    </header>

    <!-- Main body -->
    <main id="root" class="container justify-content-between h-100"></main>

    <!-- Options modal -->
    <div id="modal-options" class="modal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">Options</h2>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="container-fluid">
              <!-- Alarm sound -->
              <div class="row justify-content-center mb-3">
                <h3>Alarm:</h3>
              </div>
              <div class="row justify-content-center">
                <label for="range-volume">Volume:</label>
              </div>
              <div class="row mb-1">
                <div class="input-group">
                  <input
                    type="range"
                    name="volume"
                    id="range-volume"
                    class="mx-0 w-100"
                    min="0"
                    value="100"
                    max="100"
                  />
                </div>
              </div>
              <div class="row justify-content-center">
                <label for="sel-sound">Sound:</label>
              </div>
              <div class="row mb-5">
                <div class="input-group">
                  <select name="sel-sound" id="sel-sound" class="custom-select">
                    <option value="default">Default</option>
                    <option value="geese">Geese</option>
                    <option value="hugebell">Huge bell</option>
                    <option value="police">Police siren</option>
                    <option value="railroad">Railroad Crossing</option>
                    <option value="rooster">Rooster</option>
                    <option value="warningsiren">Warning siren</option>
                    <option value="whistling">Whistling</option>
                  </select>
                  <div class="input-group-append">
                    <a class="btn btn-outline-secondary">Listen</a>
                  </div>
                </div>
              </div>
              <!-- Session duration -->
              <div class="row justify-content-center mb-3">
                <h3>
                  Sessions duration<span class="text-muted">(in minutes)</span>:
                </h3>
              </div>
              <div class="row justify-content-center">
                <label for="text-durartion-work">Work:</label>
              </div>
              <div id="slot-work-time-input" class="row"></div>
              <div class="row justify-content-center">
                <label for="txt-durartion-break">Break:</label>
              </div>
              <div id="slot-break-time-input" class="row"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button id="btn-reset-options" class="btn btn-secondary">
              Reset
            </button>
            <button id="btn-save" class="btn btn-success" data-dismiss="modal">
              Save
            </button>
          </div>
        </div>
      </div>
    </div>

    <audio id="audio-alarm" preload="auto" src="audio/default.wav" />

    <!-- Internal script -->
    <script type="module">
      import $ from 'jquery';
      import 'bootstrap';

      import {toSecs, toMillisecs} from './js/time.mjs';
      import {Timer, TimerState} from './js/timer.mjs';
      import {TimerClockComponent} from './js/components/timer-clock-component.mjs';
      import {TimerControlsComponent} from './js/components/timer-controls-component.mjs';
      import {SpinButtonComponent} from './js/components/spin-button-component.mjs';

      const PomodoroState = {
        Inactive: 'inactive',
        Work: 'work',
        Break: 'break',
      };

      const AlarmSounds = {
        default: 'audio/default.wav',
        geese: 'audio/geese.mp3',
        hugebell: 'audio/hugebell.wav',
        police: 'audio/police.wav',
        railroad: 'audio/railroad.wav',
        rooster: 'audio/rooster.wav',
        warningsiren: 'audio/warningsiren.wav',
        whistling: 'audio/whistling.wav',
      };

      $().ready(() => {
        // Application state.
        let work_duration = 25 * 60;
        let break_duration = 5 * 60;
        let nsession = 0;
        let timer = createTimer();
        const timerClockComponent = new TimerClockComponent();

        // Timer controls.
        const timerControlsCallbacks = {
          onStart: () => set_state(TimerState.Running),
          onStop: () => set_state(TimerState.Stopped),
          onPause: () => set_state(TimerState.Paused),
          onResume: () => set_state(TimerState.Running),
          onReset: () => reset(),
          onShowOptions: () => {
            $('#modal-options').modal();
          },
        };
        const timerControlsComponent = new TimerControlsComponent(
          timerControlsCallbacks
        );

        // Timer options.

        const $rangeVolume = $('#range-volume');
        const $selSound = $('#sel-sound');
        const $txtDurationWork = $('#txt-duration-work');
        const $txtDurationBreak = $('#txt-duration-break');
        const $btnResetOptions = $('#btn-reset-options');
        const $btnSave = $('#btn-save');

        // Media resources.

        const $audioAlarm = $('#audio-alarm');

        // Event handlers.
        $btnSave.click(() => {
          // Volume.
          $audioAlarm[0].volume = $rangeVolume.val() / 100;
          // Update timer sound.
          $audioAlarm.attr('src', AlarmSounds[$selSound.val()]);
          // Fetch duration.
          work_duration = parseInt($txtDurationWork.val() * 60);
          break_duration = parseInt($txtDurationBreak.val() * 60);
          // Stop timer.
          set_state(TimerState.Stopped);
        });
        $btnResetOptions.click(reset_options);

        // Decrease and increase buttons.
        const attrAction = 'data-action';
        const attrTarget = 'data-target';
        const attrMax = 'data-max';
        const attrMin = 'data-min';
        $(`[${attrAction}]`).each((index, el) => {
          // Get target element.
          const target_selector = el.getAttribute(attrTarget);
          let target = document.querySelector(target_selector);
          if (target != null) {
            // Get clamping values.
            const max = target.getAttribute(attrMax);
            const min = target.getAttribute(attrMin);
            // Add event.
            switch (el.getAttribute(attrAction)) {
              case 'decrease':
                el.addEventListener('click', () => {
                  target.value = step(max, parseInt(target.value), min, -1);
                });
                break;
              case 'increase':
                el.addEventListener('click', () => {
                  target.value = step(max, parseInt(target.value), min, 1);
                });
                break;
            }
          } else {
            console.error(
              `Could not find target element '${target_selector}'.`
            );
          }
        });

        // Initial state.
        const $root = $('#root');
        $root.append(timerClockComponent.rootElement);
        $root.append(timerControlsComponent.rootElement);

        const $slotWorkTimeInput = $('#slot-work-time-input');
        const spinButtonWork = new SpinButtonComponent(
          work_duration / 60,
          0,
          60
        );
        $slotWorkTimeInput.append(spinButtonWork.rootElement);

        const $slotBreakTimeInput = $('#slot-break-time-input');
        const breakButtonWork = new SpinButtonComponent(
          break_duration / 60,
          0,
          60
        );
        $slotBreakTimeInput.append(breakButtonWork.rootElement);

        set_state(TimerState.Stopped);
        reset_options();

        // 'Public' functions

        function get_session_duration() {
          return is_break() ? work_duration : break_duration;
        }

        function is_break() {
          return nsession % 2 === 0;
        }

        function reset() {
          const wasRunning = timer.isRunning;
          set_session(0);
          wasRunning && timer.run();
        }

        function set_session(to) {
          nsession = to;
          timer.stop();
          timer = createTimer();
          timerClockComponent.elapsedTime = 0;
          timerClockComponent.duration = toMillisecs(get_session_duration());
          timerClockComponent.session = nsession;
          timerClockComponent.sessionType = nsession % 2;
        }

        function set_state(new_state) {
          const old_state = timer ? timer.state : undefined;
          const state = new_state;
          if (typeof old_state !== 'undefined') {
            switch (old_state) {
              case TimerState.Paused:
                break;
              case TimerState.Stopped:
                timer = createTimer();
              case TimerState.Running:
                break;
            }
          }
          switch (new_state) {
            case TimerState.Running:
              timer.run();
              break;
            case TimerState.Paused:
              timer.pause();
              break;
            case TimerState.Stopped:
            default:
              timer.stop();
              timerClockComponent.elapsedTime = 0;
              timerClockComponent.duration = toMillisecs(
                get_session_duration()
              );
              break;
          }
          timerClockComponent.timerState = new_state;
          timerControlsComponent.timerState = new_state;
        }

        // 'Private' functions

        function createTimer() {
          return new Timer(
            toMillisecs(get_session_duration()),
            () => {
              set_session(nsession + 1);
              $audioAlarm[0].play();
              timer.run();
            },
            ({elapsedTime}) => {
              timerClockComponent.elapsedTime = elapsedTime;
            }
          );
        }

        function reset_options() {
          $rangeVolume.val(100);
          $txtDurationWork.val(25);
          $txtDurationBreak.val(5);
          $selSound.val('default');
        }

        function button_swap(button, text, from, to) {
          button.text(text);
          button.removeClass(from);
          button.addClass(to);
        }

        function step(max, value, min, step) {
          value += step;
          if (max != null) {
            value = Math.min(parseInt(max), value);
          }
          if (min != null) {
            value = Math.max(parseInt(min), value);
          }
          return value;
        }
      });
    </script>
  </body>
</html>
