<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />

    <style>
      #timer {
        border-radius: 50%;
        width: 315px;
        height: 315px;
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        background-color: #ccc;
        background-image: none;
        margin: 20px;
      }

      #timer-overlay {
        border-radius: 50%;
        width: 299px;
        height: 299px;
        margin: auto;
        background: #fff;
        text-align: center;
        padding-top: 32%;
        display: flex;
        flex-direction: column;
      }

      #timer-time {
        top: 50%;
        font-size: 64px;
        font-weight: bolder;
      }

      #timer-state {
        font-size: 24px;
        font-weight: bold;
      }

      #timer-session {
        font-size: 18px;
        font-weight: normal;
      }

      #timer.inactive {
        background-color: #6c757d;
      }

      #timer-time.inactive {
        color: #6c757d;
      }

      #timer.work {
        background-color: #007bff;
      }

      #timer-time.work {
        color: #007bff;
      }

      #timer.break {
        background-color: #ffc107;
      }

      #timer-time.break {
        color: #ffc107;
      }

      /* .progress-10 {
            background-image: linear-gradient(45deg, #028cd5 50%, transparent 50%), linear-gradient(180deg, #028cd5 50%, #ddd 50%);
        } */
    </style>

    <title>Pomodoro Clock</title>
  </head>

  <body>
    <!-- Title -->
    <header class="jumbotron jumbotron-fluid bg-transparent text-center py-4">
      <div class="container">
        <h1 class="display-4">Pomodoro Clock</h1>
      </div>
    </header>

    <!-- Main body -->
    <main class="container justify-content-between h-100">
      <!-- Clock timer -->
      <div id="timer" class="mx-auto mb-5">
        <div id="timer-overlay">
          <span id="timer-time">25:00</span>
          <span id="timer-state">Ready?</span>
          <span id="timer-session">Session 0</span>
        </div>
      </div>
      <!-- Controls -->
      <section class="container">
        <div id="panel-controls">
          <div class="row mb-2">
            <button id="btn-start" class="btn btn-success col-12">Start</button>
          </div>
          <div id="panel-subcontrols" class="row mb-2">
            <button
              id="btn-pause"
              class="btn btn-secondary col-12 col-md-5 mr-auto mb-2"
            >
              Pause
            </button>
            <button
              id="btn-reset"
              class="btn btn-secondary col-12 col-md-5 mb-2"
            >
              Reset
            </button>
          </div>
          <div id="panel-options" class="row mb-2">
            <button
              id="btn-options"
              class="btn btn-secondary col-12"
              data-toggle="modal"
              data-target="#modal-options"
            >
              Options
            </button>
          </div>
        </div>
      </section>
    </main>

    <!-- Options modal -->
    <div id="modal-options" class="modal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">Options</h2>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="container-fluid">
              <!-- Alarm sound -->
              <div class="row justify-content-center mb-3">
                <h3>Alarm:</h3>
              </div>
              <div class="row justify-content-center">
                <label for="range-volume">Volume:</label>
              </div>
              <div class="row mb-1">
                <div class="input-group">
                  <input
                    type="range"
                    name="volume"
                    id="range-volume"
                    class="mx-0 w-100"
                    min="0"
                    value="100"
                    max="100"
                  />
                </div>
              </div>
              <div class="row justify-content-center">
                <label for="sel-sound">Sound:</label>
              </div>
              <div class="row mb-5">
                <div class="input-group">
                  <select name="sel-sound" id="sel-sound" class="custom-select">
                    <option value="default">Default</option>
                    <option value="geese">Geese</option>
                    <option value="hugebell">Huge bell</option>
                    <option value="police">Police siren</option>
                    <option value="railroad">Railroad Crossing</option>
                    <option value="rooster">Rooster</option>
                    <option value="warningsiren">Warning siren</option>
                    <option value="whistling">Whistling</option>
                  </select>
                  <div class="input-group-append">
                    <a class="btn btn-outline-secondary">Listen</a>
                  </div>
                </div>
              </div>
              <!-- Session duration -->
              <div class="row justify-content-center mb-3">
                <h3>
                  Sessions duration<span class="text-muted">(in minutes)</span>:
                </h3>
              </div>
              <div class="row justify-content-center">
                <label for="text-durartion-work">Work:</label>
              </div>
              <div class="row">
                <div class="input-group mb-2">
                  <div class="input-group-prepend">
                    <button
                      class="btn btn-outline-secondary"
                      data-action="decrease"
                      data-target="#txt-duration-work"
                    >
                      &lt;
                    </button>
                  </div>
                  <input
                    name="duration-work"
                    id="txt-duration-work"
                    type="number"
                    step="1"
                    min="0"
                    max="60"
                    class="form-control text-center"
                  />
                  <div class="input-group-append">
                    <button
                      class="btn btn-outline-secondary"
                      data-action="increase"
                      data-target="#txt-duration-work"
                    >
                      &gt;
                    </button>
                  </div>
                </div>
              </div>
              <div class="row justify-content-center">
                <label for="txt-durartion-break">Break:</label>
              </div>
              <div class="row">
                <div class="input-group">
                  <div class="input-group-prepend">
                    <button
                      class="btn btn-outline-secondary"
                      data-action="decrease"
                      data-target="#txt-duration-break"
                    >
                      &lt;
                    </button>
                  </div>
                  <input
                    name="duration-break"
                    id="txt-duration-break"
                    type="number"
                    step="1"
                    min="0"
                    max="60"
                    class="form-control text-center"
                  />
                  <div class="input-group-append">
                    <button
                      class="btn btn-outline-secondary"
                      data-action="increase"
                      data-target="#txt-duration-break"
                    >
                      &gt;
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button id="btn-reset-options" class="btn btn-secondary">
              Reset
            </button>
            <button id="btn-save" class="btn btn-success" data-dismiss="modal">
              Save
            </button>
          </div>
        </div>
      </div>
    </div>

    <audio id="audio-alarm" preload="auto" src="audio/default.wav" />

    <!-- Bootstrap -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script
      src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
      integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>

    <!-- Internal script -->
    <script type="module">
      import {toSecs, toMillisecs} from './js/time.mjs';
      import {Clock, ClockStates} from './js/clock.mjs';

      const TimerStates = {
        Inactive: 'inactive',
        Work: 'work',
        Break: 'break',
      };

      const AlarmSounds = {
        default: 'audio/default.wav',
        geese: 'audio/geese.mp3',
        hugebell: 'audio/hugebell.wav',
        police: 'audio/police.wav',
        railroad: 'audio/railroad.wav',
        rooster: 'audio/rooster.wav',
        warningsiren: 'audio/warningsiren.wav',
        whistling: 'audio/whistling.wav',
      };

      $().ready(() => {
        // Application state.
        let nsession = 0;
        let clock = new Clock((elapsedTime) =>
          onClockTick(toSecs(elapsedTime))
        );
        let work_duration = 25 * 60;
        let break_duration = 5 * 60;

        // Timer clock.

        const $timer = $('#timer');
        const $timerTime = $('#timer-time');
        const $timerState = $('#timer-state');
        const $timerSession = $('#timer-session');
        const timer_background = '#e9ecef';
        let timer_state = undefined;
        let timer_progress = 0;

        // Timer controls.

        const $btnStart = $('#btn-start');
        const $panelSubcontrols = $('#panel-subcontrols');
        const $btnPause = $('#btn-pause');
        const $btnReset = $('#btn-reset');
        const $panelOptions = $('#panel-options');

        // Timer options.

        const $rangeVolume = $('#range-volume');
        const $selSound = $('#sel-sound');
        const $txtDurationWork = $('#txt-duration-work');
        const $txtDurationBreak = $('#txt-duration-break');
        const $btnResetOptions = $('#btn-reset-options');
        const $btnSave = $('#btn-save');

        // Media resources.

        const $audioAlarm = $('#audio-alarm');

        // Event handlers.

        $btnStart.click(() => {
          if (clock.state === ClockStates.Stopped) {
            set_state(ClockStates.Running);
          } else {
            set_state(ClockStates.Stopped);
          }
        });

        $btnPause.click(() => {
          if (clock.state === ClockStates.Paused) {
            set_state(ClockStates.Running);
          } else {
            set_state(ClockStates.Paused);
          }
        });

        $btnReset.click(reset);

        $btnSave.click(() => {
          // Volume.
          $audioAlarm[0].volume = $rangeVolume.val() / 100;
          // Update timer sound.
          $audioAlarm.attr('src', AlarmSounds[$selSound.val()]);
          // Fetch duration.
          work_duration = parseInt($txtDurationWork.val() * 60);
          break_duration = parseInt($txtDurationBreak.val() * 60);
          // Update time measurement.
          update_time(clock.elapsedSeconds);
        });

        $btnResetOptions.click(reset_options);

        // Decrease and increase buttons.
        const attrAction = 'data-action';
        const attrTarget = 'data-target';
        const attrMax = 'data-max';
        const attrMin = 'data-min';
        $(`[${attrAction}]`).each((index, el) => {
          // Get target element.
          const target_selector = el.getAttribute(attrTarget);
          let target = document.querySelector(target_selector);
          if (target != null) {
            // Get clamping values.
            const max = target.getAttribute(attrMax);
            const min = target.getAttribute(attrMin);
            // Add event.
            switch (el.getAttribute(attrAction)) {
              case 'decrease':
                el.addEventListener('click', () => {
                  target.value = step(max, parseInt(target.value), min, -1);
                });
                break;
              case 'increase':
                el.addEventListener('click', () => {
                  target.value = step(max, parseInt(target.value), min, 1);
                });
                break;
            }
          } else {
            console.error(
              `Could not find target element '${target_selector}'.`
            );
          }
        });

        // Initial state.
        set_state(ClockStates.Stopped);
        reset_options();

        // 'Public' functions

        function get_session_duration() {
          return is_break() ? work_duration : break_duration;
        }

        function is_break() {
          return nsession % 2 === 0;
        }

        function reset() {
          set_session(0);
          clock.reset();
        }

        function onClockTick(elapsedSeconds) {
          if (elapsedSeconds > get_session_duration()) {
            set_session(nsession + 1);
            $audioAlarm[0].play();
            return true;
          } else {
            update_time(elapsedSeconds);
          }
        }

        function set_session(to) {
          nsession = to;
          update_timer();
        }

        function set_state(new_state) {
          let old_state = clock.state;
          if (typeof old_state !== 'undefined') {
            switch (old_state) {
              case ClockStates.Paused:
                // Change Resume to Pause.
                button_swap($btnPause, 'Pause', 'btn-success', 'btn-secondary');
                break;
              case ClockStates.Stopped:
              default:
                // Change Stop to Start.
                button_swap($btnStart, 'Stop', 'btn-success', 'btn-danger');
                // Show subcontrols.
                $panelSubcontrols.show();
                // Hide options.
                $panelOptions.hide();
                break;
            }
          }
          switch (new_state) {
            case ClockStates.Running:
              // Change Resume to Pause.
              button_swap($btnPause, 'Pause', 'btn-success', 'btn-secondary');
              clock.run();
              break;
            case ClockStates.Paused:
              // Change Pause to Resume.
              button_swap($btnPause, 'Resume', 'btn-secondary', 'btn-success');
              clock.pause();
              break;
            case ClockStates.Stopped:
            default:
              // Change Start to Stop.
              button_swap($btnStart, 'Start', 'btn-danger', 'btn-success');
              // Hide subcontrols.
              $panelSubcontrols.hide();
              // Show options.
              $panelOptions.show();
              clock.stop();
              break;
          }

          // Reset already updates the timer.
          if (clock.state != ClockStates.Stopped) {
            // Update timer.
            update_timer();
          }
        }

        // 'Private' functions

        function reset_options() {
          $rangeVolume.val(100);
          $txtDurationWork.val(25);
          $txtDurationBreak.val(5);
          $selSound.val('default');
        }

        function button_swap(button, text, from, to) {
          button.text(text);
          button.removeClass(from);
          button.addClass(to);
        }

        function pad_left_number(number, padding) {
          return `${'0'.repeat(padding)}${number}`.slice(-padding);
        }

        function set_timer_clock_state(new_state) {
          if (timer_state) {
            $timer.removeClass(timer_state);
            $timerTime.removeClass(timer_state);
          }
          timer_state = new_state;
          if (timer_state) {
            $timer.addClass(timer_state);
            $timerTime.addClass(timer_state);
          }
          update_gradient();
        }

        function set_timer_progress(p) {
          p = Math.min(1, Math.max(0, p));
          timer_progress = p;
          update_gradient();
        }

        function step(max, value, min, step) {
          value += step;
          if (max != null) {
            value = Math.min(parseInt(max), value);
          }
          if (min != null) {
            value = Math.max(parseInt(min), value);
          }
          return value;
        }

        function update_gradient() {
          // Convert decimal to degrees.
          const deg = timer_progress * 360;
          // Get colors.
          let a = $timer.css('background-color');
          let b = timer_background;
          // Build gradients.
          let gradient = undefined;
          if (deg > 180) {
            gradient = `linear-gradient(${
              deg + 180
            }deg, ${b} 50%, transparent 50%), linear-gradient(180deg, ${a} 50%, ${b} 50%)`;
          } else {
            gradient = `linear-gradient(${deg}deg, ${a} 50%, transparent 50%), linear-gradient(180deg, ${a} 50%, ${b} 50%)`;
          }
          // Apply gradients.
          $timer.css('background-image', gradient);
        }

        function update_time(elapsedSeconds) {
          let duration = get_session_duration();

          // Calculating the remaining time.
          const remaining_time = duration - Math.round(elapsedSeconds);

          // Calculating the minutes and seconds of the timer.
          let seconds = remaining_time % 60;
          let minutes = (remaining_time - seconds) / 60;

          // Updating the timer label.
          $timerTime.text(
            `${pad_left_number(minutes, 2)}:${pad_left_number(seconds, 2)}`
          );

          // Update the timer.
          set_timer_progress(elapsedSeconds / duration);
        }

        function update_timer() {
          switch (clock.state) {
            case ClockStates.Running:
              set_timer_clock_state(
                is_break() ? TimerStates.Break : TimerStates.Work
              );
              $timerState.text(`${is_break() ? 'Work' : 'Break'}`);
              break;
            case ClockStates.Paused:
              set_timer_clock_state(TimerStates.Inactive);
              $timerState.text(`${is_break() ? 'Work' : 'Break'}(Paused)`);
              break;
            case ClockStates.Stopped:
            default:
              set_timer_clock_state(TimerStates.Inactive);
              $timerState.text('Ready?');
              break;
          }
          $timerSession.text(
            clock.state !== ClockStates.Stopped ? `Session ${nsession + 1}` : ''
          );
        }
      });
    </script>
  </body>
</html>
